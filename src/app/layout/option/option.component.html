<!--
https://www.nseindia.com/api/master-quote
https://www.nseindia.com/api/option-chain-equities?symbol=ABB
https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY

-->

<div
  *ngIf="{
    data: data.$data | async,
    masterQuote: data.$masterQuote | async
  } as _data"
>
  <div class="mt-2" *ngIf="_data.data != null">
    <div class="row">
      <div class="col-3">
        <select
          [(ngModel)]="data.contracts"
          (change)="h_contracts('/api/option/', data.contracts)"
          class="form-select form-select-sm"
        >
          <option>--Select--</option>
          <option
            *ngFor="let i of ['NIFTY', 'FINNIFTY', 'BANKNIFTY', 'MIDCPNIFTY']"
            [value]="i"
          >
            {{ i }}
          </option>
        </select>
      </div>
      <div class="col-3">
        <select
          [(ngModel)]="data.contracts"
          (change)="h_contracts('/api/option-equities/', data.contracts)"
          class="form-select form-select-sm"
        >
          <option>--Select--</option>
          <option *ngFor="let i of oa(_data.masterQuote)" [value]="i">
            {{ i }}
          </option>
        </select>
      </div>
      <div class="col-6">
        <button
          type="button"
          class="btn btn-sm btn-danger me-2"
          (click)="reset(data, _data)"
        >
          <i class="fa-solid fa-arrows-rotate text-white"></i>
        </button>
        <button
          type="button"
          class="btn btn-sm btn-danger me-2"
          (click)="h_html2canvas('#html_to_jpeg')"
        >
          <i class="fa-solid fa-camera text-white"></i>
        </button>
      </div>
    </div>
    <div class="row" id="html_to_jpeg">
      <div
        class="col-md-6 col-lg-6 col-12"
        *ngFor="let i of ob(_data.data)['expiryData_key']"
      >
        <span class="fw-semibold">
          {{ i }}
        </span>
        Underlying Index:
        <span class="fw-semibold">
          {{ data.contracts }}
        </span>
        <span class="fw-semibold">
          {{ ob(_data.data).data.records.underlyingValue | number }}
        </span>
        As on

        <span class="fw-semibold">
          {{ ob(_data.data).data.records.timestamp }}
        </span>

        <span class="badge text-bg-primary"></span>
        <table
          id="example"
          class="table table-sm table-striped table-hover mt-2"
        >
          <thead class="header-fixed bg" (click)="show(data, _data)">
            <tr>
              <th></th>
              <th class="text-end">OI</th>
              <th class="text-end">COI</th>

              <th class="text-end">lastPrice</th>
              <th class="text-center">Strike Price</th>
              <th class="text-end">lastPrice</th>
              <th class="text-end">COI</th>
              <th class="text-end">OI</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let i of ob(_data.data).expiryData[i]">
              <!--             'text-danger': ((i.CE.change || 0 ) < 0),
                'text-success':   ((i.CE.change || 0 ) > 0),-->
              <td class="text-center">
                <i
                  class="fa-solid fa-chart-line"
                  (click)="put_call_chart_id_open('#put_call_chart_id', i)"
                ></i>
              </td>
              <td
                class="text-end"
                [class]="{
                  'bg-primary-subtle': i.flag < 50,
                  'text-danger': (i.CE.change || 0) < 0,
                  'text-success': (i.CE.change || 0) > 0
                }"
                [title]="i.CE.change"
              >
                {{ i.CE.openInterest | number }}
              </td>
              <td
                class="text-end"
                [class]="{
                  'bg-primary-subtle': i.flag < 50,
                  'text-danger': (i.CE.change || 0) < 0,
                  'text-success': (i.CE.change || 0) > 0
                }"
                [title]="i.CE.change"
              >
                {{ i.CE.changeinOpenInterest | number }}
              </td>

              <td
                class="text-end"
                [class]="{
                  'bg-primary-subtle': i.flag < 50,
                  'text-danger': (i.CE.change || 0) < 0,
                  'text-success': (i.CE.change || 0) > 0
                }"
              >
                {{ n(i.CE.lastPrice) }}
              </td>
              <td class="text-center">
                {{ i.strikePrice | number }}
              </td>
              <td
                class="text-end"
                [class]="{
                  'bg-primary-subtle': i.flag > 50,
                  'text-danger': (i.PE.change || 0) < 0,
                  'text-success': (i.PE.change || 0) > 0
                }"
              >
                {{ n(i.PE.lastPrice) }}
              </td>

              <td
                class="text-end"
                [class]="{
                  'bg-primary-subtle': i.flag > 50,
                  'text-danger': (i.PE.change || 0) < 0,
                  'text-success': (i.PE.change || 0) > 0
                }"
                [title]="i.PE.change"
              >
                {{ i.PE.changeinOpenInterest | number }}
              </td>

              <td
                class="text-end"
                [class]="{
                  'bg-primary-subtle': i.flag > 50,
                  'text-danger': (i.PE.change || 0) < 0,
                  'text-success': (i.PE.change || 0) > 0
                }"
                [title]="i.PE.change"
              >
                {{ i.PE.openInterest | number }}
              </td>
              <td class="text-center">
                <i
                  class="fa-solid fa-chart-line"
                  (click)="put_call_chart_id_open('#put_call_chart_id', i)"
                ></i>
              </td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<button
  type="button"
  class="btn btn-primary d-none"
  id="put_call_chart_id"
  data-bs-toggle="modal"
  data-bs-target="#put_call_chart"
>
  Launch demo modal
</button>

<!-- Modal -->
<div
  class="modal fade"
  id="put_call_chart"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body"><div id="container"></div></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
